<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>nlisim.modules.transferrin API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS_CHTML" integrity="sha256-kZafAc6mZvK3W3v1pHOcUix30OHQN6pU/NO2oFkqZVw=" crossorigin></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>nlisim.modules.transferrin</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">import math
from typing import Any, Dict

import attr
from attr import attrib, attrs
import numpy as np

from nlisim.coordinates import Voxel
from nlisim.diffusion import apply_diffusion
from nlisim.grid import RectangularGrid
from nlisim.module import ModuleModel, ModuleState
from nlisim.state import State
from nlisim.util import iron_tf_reaction


def molecule_grid_factory(self: &#39;TransferrinState&#39;) -&gt; np.ndarray:
    return np.zeros(
        shape=self.global_state.grid.shape,
        dtype=[(&#39;Tf&#39;, np.float64), (&#39;TfFe&#39;, np.float64), (&#39;TfFe2&#39;, np.float64)],
    )


@attrs(kw_only=True, repr=False)
class TransferrinState(ModuleState):
    grid: np.ndarray = attrib(
        default=attr.Factory(molecule_grid_factory, takes_self=True)
    )  # units: atto-mols
    k_m_tf_tafc: float  # units: aM
    p1: float
    p2: float
    p3: float
    threshold_log_hep: float
    threshold_hep: float
    default_apotf_rel_concentration: float  # units: proportion
    default_tffe_rel_concentration: float  # units: proportion
    default_tffe2_rel_concentration: float  # units: proportion
    default_tf_concentration: float
    default_apotf_concentration: float
    default_tffe_concentration: float
    default_tffe2_concentration: float
    tf_intercept: float
    tf_slope: float
    iron_imp_exp_t: float
    ma_iron_import_rate: float
    ma_iron_export_rate: float
    rel_iron_imp_exp_unit_t: float


class Transferrin(ModuleModel):
    &#34;&#34;&#34;Transferrin&#34;&#34;&#34;

    name = &#39;transferrin&#39;
    StateClass = TransferrinState

    def initialize(self, state: State) -&gt; State:
        transferrin: TransferrinState = state.transferrin
        voxel_volume = state.voxel_volume

        # config file values
        transferrin.k_m_tf_tafc = self.config.getfloat(&#39;k_m_tf_tafc&#39;)  # units: aM
        transferrin.p1 = self.config.getfloat(&#39;p1&#39;)
        transferrin.p2 = self.config.getfloat(&#39;p2&#39;)
        transferrin.p3 = self.config.getfloat(&#39;p3&#39;)
        transferrin.threshold_log_hep = self.config.getfloat(&#39;threshold_log_hep&#39;)

        transferrin.tf_intercept = self.config.getfloat(&#39;tf_intercept&#39;)
        transferrin.tf_slope = self.config.getfloat(&#39;tf_slope&#39;)

        transferrin.default_apotf_rel_concentration = self.config.getfloat(
            &#39;default_apotf_rel_concentration&#39;
        )  # units: proportion
        transferrin.default_tffe_rel_concentration = self.config.getfloat(
            &#39;default_tffe_rel_concentration&#39;
        )  # units: proportion
        transferrin.default_tffe2_rel_concentration = self.config.getfloat(
            &#39;default_tffe2_rel_concentration&#39;
        )  # units: proportion

        transferrin.iron_imp_exp_t = self.config.getfloat(&#39;iron_imp_exp_t&#39;)

        # computed values
        transferrin.threshold_hep = math.pow(10, transferrin.threshold_log_hep)
        transferrin.default_tf_concentration = (
            transferrin.tf_intercept + transferrin.tf_slope * transferrin.threshold_log_hep
        ) * voxel_volume  # units: aM
        transferrin.default_apotf_concentration = (
            transferrin.default_apotf_rel_concentration * transferrin.default_tf_concentration
        )  # units: aM
        transferrin.default_tffe_concentration = (
            transferrin.default_tffe_rel_concentration * transferrin.default_tf_concentration
        )  # units: aM
        transferrin.default_tffe2_concentration = (
            transferrin.default_tffe2_rel_concentration * transferrin.default_tf_concentration
        )  # units: aM

        transferrin.rel_iron_imp_exp_unit_t = (
            transferrin.iron_imp_exp_t / self.time_step
        )  # units: ? / (min/step) = ? * step / min TODO: units
        # TODO: I just commented out the voxel_volume code in the config file. Putting it here.
        #  Adjust comments in config?
        transferrin.ma_iron_import_rate = self.config.getfloat(&#39;ma_iron_import_rate&#39;) / voxel_volume
        transferrin.ma_iron_export_rate = self.config.getfloat(&#39;ma_iron_export_rate&#39;) / voxel_volume

        # initialize the molecular field
        transferrin.grid[&#39;Tf&#39;] = transferrin.default_apotf_concentration
        transferrin.grid[&#39;TfFe&#39;] = transferrin.default_tffe_concentration
        transferrin.grid[&#39;TfFe2&#39;] = transferrin.default_tffe2_concentration

        return state

    def advance(self, state: State, previous_time: float) -&gt; State:
        &#34;&#34;&#34;Advance the state by a single time step.&#34;&#34;&#34;
        from nlisim.modules.iron import IronState
        from nlisim.modules.macrophage import MacrophageCellData, MacrophageState
        from nlisim.modules.molecules import MoleculesState
        from nlisim.modules.phagocyte import PhagocyteStatus

        transferrin: TransferrinState = state.transferrin
        iron: IronState = state.iron
        macrophage: MacrophageState = state.macrophage
        molecules: MoleculesState = state.molecules
        grid: RectangularGrid = state.grid
        # molecules: MoleculesState = state.molecules

        # interact with macrophages
        for macrophage_cell_index in macrophage.cells.alive():
            macrophage_cell: MacrophageCellData = macrophage.cells[macrophage_cell_index]
            macrophage_cell_voxel: Voxel = grid.get_voxel(macrophage_cell[&#39;point&#39;])

            # TODO: what is going on with these min&#39;s? hard to believe that these constants will &gt; 1
            qtty_fe2 = transferrin.grid[&#39;TfFe2&#39;][tuple(macrophage_cell_voxel)] * min(
                1.0, transferrin.ma_iron_import_rate * transferrin.rel_iron_imp_exp_unit_t
            )

            qtty_fe = transferrin.grid[&#39;TfFe&#39;][tuple(macrophage_cell_voxel)] * min(
                1.0, transferrin.ma_iron_import_rate * transferrin.rel_iron_imp_exp_unit_t
            )

            # macrophage uptakes iron, leaves transferrin+0Fe behind
            transferrin.grid[&#39;TfFe2&#39;][tuple(macrophage_cell_voxel)] -= qtty_fe2
            transferrin.grid[&#39;TfFe&#39;][tuple(macrophage_cell_voxel)] -= qtty_fe
            transferrin.grid[&#39;Tf&#39;][tuple(macrophage_cell_voxel)] += qtty_fe + qtty_fe2
            macrophage_cell[&#39;iron_pool&#39;] += 2 * qtty_fe2 + qtty_fe

            if macrophage_cell[&#39;fpn&#39;] and macrophage_cell[&#39;status&#39;] not in {
                PhagocyteStatus.ACTIVE,
                PhagocyteStatus.ACTIVATING,
            }:
                # amount of iron to export is bounded by the amount of iron in the cell as well
                # as the amount which can be accepted by transferrin TODO: ask why not 2*Tf+TfFe?
                qtty: np.float64 = min(
                    macrophage_cell[&#39;iron_pool&#39;],
                    2 * transferrin.grid[&#39;Tf&#39;][tuple(macrophage_cell_voxel)],
                    macrophage_cell[&#39;iron_pool&#39;]
                    * transferrin.grid[&#39;Tf&#39;][tuple(macrophage_cell_voxel)]
                    * transferrin.ma_iron_export_rate
                    * transferrin.rel_iron_imp_exp_unit_t,
                )
                rel_tf_fe = iron_tf_reaction(
                    iron=qtty,
                    tf=transferrin.grid[&#39;Tf&#39;][tuple(macrophage_cell_voxel)],
                    tf_fe=transferrin.grid[&#39;TfFe&#39;][tuple(macrophage_cell_voxel)],
                    p1=transferrin.p1,
                    p2=transferrin.p2,
                    p3=transferrin.p3,
                )
                tffe_qtty = rel_tf_fe * qtty
                tffe2_qtty = (qtty - tffe_qtty) / 2

                transferrin.grid[&#39;Tf&#39;][tuple(macrophage_cell_voxel)] -= tffe_qtty + tffe2_qtty
                transferrin.grid[&#39;TfFe&#39;][tuple(macrophage_cell_voxel)] += tffe_qtty
                transferrin.grid[&#39;TfFe2&#39;][tuple(macrophage_cell_voxel)] += tffe2_qtty
                macrophage_cell[&#39;iron_pool&#39;] -= qtty

        # interaction with iron: transferrin -&gt; transferrin+[1,2]Fe
        transferrin_fe_capacity = 2 * transferrin.grid[&#39;Tf&#39;] + transferrin.grid[&#39;TfFe&#39;]
        potential_reactive_quantity = np.minimum(iron.grid, transferrin_fe_capacity)
        rel_tf_fe = iron_tf_reaction(
            iron=potential_reactive_quantity,
            tf=transferrin.grid[&#34;Tf&#34;],
            tf_fe=transferrin.grid[&#34;TfFe&#34;],
            p1=transferrin.p1,
            p2=transferrin.p2,
            p3=transferrin.p3,
        )
        tffe_qtty = rel_tf_fe * potential_reactive_quantity
        tffe2_qtty = (potential_reactive_quantity - tffe_qtty) / 2
        transferrin.grid[&#39;Tf&#39;] -= tffe_qtty + tffe2_qtty
        transferrin.grid[&#39;TfFe&#39;] += tffe_qtty
        transferrin.grid[&#39;TfFe2&#39;] += tffe2_qtty
        iron.grid -= potential_reactive_quantity
        # Note: asked Henrique why there is no transferrin+Fe -&gt; transferrin+2Fe reaction
        # answer was that this should already be accounted for

        # Degrade transferrin: done in liver

        # Diffusion of transferrin
        for component in {&#39;Tf&#39;, &#39;TfFe&#39;, &#39;TfFe2&#39;}:
            transferrin.grid[component][:] = apply_diffusion(
                variable=transferrin.grid[component],
                laplacian=molecules.laplacian,
                diffusivity=molecules.diffusion_constant,
                dt=self.time_step,
            )

        return state

    def summary_stats(self, state: State) -&gt; Dict[str, Any]:
        transferrin: TransferrinState = state.transferrin
        voxel_volume = state.voxel_volume

        concentration_0fe = np.mean(transferrin.grid[&#39;Tf&#39;]) / voxel_volume
        concentration_1fe = np.mean(transferrin.grid[&#39;TfFe&#39;]) / voxel_volume
        concentration_2fe = np.mean(transferrin.grid[&#39;TfFe2&#39;]) / voxel_volume

        concentration = concentration_0fe + concentration_1fe + concentration_2fe

        return {
            &#39;concentration&#39;: float(concentration),
            &#39;+0Fe concentration&#39;: float(concentration_0fe),
            &#39;+1Fe concentration&#39;: float(concentration_1fe),
            &#39;+2Fe concentration&#39;: float(concentration_2fe),
        }

    def visualization_data(self, state: State):
        transferrin: TransferrinState = state.transferrin
        return &#39;molecule&#39;, transferrin.grid</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="nlisim.modules.transferrin.molecule_grid_factory"><code class="name flex">
<span>def <span class="ident">molecule_grid_factory</span></span>(<span>self: <a title="nlisim.modules.transferrin.TransferrinState" href="#nlisim.modules.transferrin.TransferrinState">TransferrinState</a>) ‑> numpy.ndarray</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def molecule_grid_factory(self: &#39;TransferrinState&#39;) -&gt; np.ndarray:
    return np.zeros(
        shape=self.global_state.grid.shape,
        dtype=[(&#39;Tf&#39;, np.float64), (&#39;TfFe&#39;, np.float64), (&#39;TfFe2&#39;, np.float64)],
    )</code></pre>
</details>
</dd>
</dl>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="nlisim.modules.transferrin.Transferrin"><code class="flex name class">
<span>class <span class="ident">Transferrin</span></span>
<span>(</span><span>config: <a title="nlisim.config.SimulationConfig" href="../config.html#nlisim.config.SimulationConfig">SimulationConfig</a>)</span>
</code></dt>
<dd>
<div class="desc"><p>Transferrin</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class Transferrin(ModuleModel):
    &#34;&#34;&#34;Transferrin&#34;&#34;&#34;

    name = &#39;transferrin&#39;
    StateClass = TransferrinState

    def initialize(self, state: State) -&gt; State:
        transferrin: TransferrinState = state.transferrin
        voxel_volume = state.voxel_volume

        # config file values
        transferrin.k_m_tf_tafc = self.config.getfloat(&#39;k_m_tf_tafc&#39;)  # units: aM
        transferrin.p1 = self.config.getfloat(&#39;p1&#39;)
        transferrin.p2 = self.config.getfloat(&#39;p2&#39;)
        transferrin.p3 = self.config.getfloat(&#39;p3&#39;)
        transferrin.threshold_log_hep = self.config.getfloat(&#39;threshold_log_hep&#39;)

        transferrin.tf_intercept = self.config.getfloat(&#39;tf_intercept&#39;)
        transferrin.tf_slope = self.config.getfloat(&#39;tf_slope&#39;)

        transferrin.default_apotf_rel_concentration = self.config.getfloat(
            &#39;default_apotf_rel_concentration&#39;
        )  # units: proportion
        transferrin.default_tffe_rel_concentration = self.config.getfloat(
            &#39;default_tffe_rel_concentration&#39;
        )  # units: proportion
        transferrin.default_tffe2_rel_concentration = self.config.getfloat(
            &#39;default_tffe2_rel_concentration&#39;
        )  # units: proportion

        transferrin.iron_imp_exp_t = self.config.getfloat(&#39;iron_imp_exp_t&#39;)

        # computed values
        transferrin.threshold_hep = math.pow(10, transferrin.threshold_log_hep)
        transferrin.default_tf_concentration = (
            transferrin.tf_intercept + transferrin.tf_slope * transferrin.threshold_log_hep
        ) * voxel_volume  # units: aM
        transferrin.default_apotf_concentration = (
            transferrin.default_apotf_rel_concentration * transferrin.default_tf_concentration
        )  # units: aM
        transferrin.default_tffe_concentration = (
            transferrin.default_tffe_rel_concentration * transferrin.default_tf_concentration
        )  # units: aM
        transferrin.default_tffe2_concentration = (
            transferrin.default_tffe2_rel_concentration * transferrin.default_tf_concentration
        )  # units: aM

        transferrin.rel_iron_imp_exp_unit_t = (
            transferrin.iron_imp_exp_t / self.time_step
        )  # units: ? / (min/step) = ? * step / min TODO: units
        # TODO: I just commented out the voxel_volume code in the config file. Putting it here.
        #  Adjust comments in config?
        transferrin.ma_iron_import_rate = self.config.getfloat(&#39;ma_iron_import_rate&#39;) / voxel_volume
        transferrin.ma_iron_export_rate = self.config.getfloat(&#39;ma_iron_export_rate&#39;) / voxel_volume

        # initialize the molecular field
        transferrin.grid[&#39;Tf&#39;] = transferrin.default_apotf_concentration
        transferrin.grid[&#39;TfFe&#39;] = transferrin.default_tffe_concentration
        transferrin.grid[&#39;TfFe2&#39;] = transferrin.default_tffe2_concentration

        return state

    def advance(self, state: State, previous_time: float) -&gt; State:
        &#34;&#34;&#34;Advance the state by a single time step.&#34;&#34;&#34;
        from nlisim.modules.iron import IronState
        from nlisim.modules.macrophage import MacrophageCellData, MacrophageState
        from nlisim.modules.molecules import MoleculesState
        from nlisim.modules.phagocyte import PhagocyteStatus

        transferrin: TransferrinState = state.transferrin
        iron: IronState = state.iron
        macrophage: MacrophageState = state.macrophage
        molecules: MoleculesState = state.molecules
        grid: RectangularGrid = state.grid
        # molecules: MoleculesState = state.molecules

        # interact with macrophages
        for macrophage_cell_index in macrophage.cells.alive():
            macrophage_cell: MacrophageCellData = macrophage.cells[macrophage_cell_index]
            macrophage_cell_voxel: Voxel = grid.get_voxel(macrophage_cell[&#39;point&#39;])

            # TODO: what is going on with these min&#39;s? hard to believe that these constants will &gt; 1
            qtty_fe2 = transferrin.grid[&#39;TfFe2&#39;][tuple(macrophage_cell_voxel)] * min(
                1.0, transferrin.ma_iron_import_rate * transferrin.rel_iron_imp_exp_unit_t
            )

            qtty_fe = transferrin.grid[&#39;TfFe&#39;][tuple(macrophage_cell_voxel)] * min(
                1.0, transferrin.ma_iron_import_rate * transferrin.rel_iron_imp_exp_unit_t
            )

            # macrophage uptakes iron, leaves transferrin+0Fe behind
            transferrin.grid[&#39;TfFe2&#39;][tuple(macrophage_cell_voxel)] -= qtty_fe2
            transferrin.grid[&#39;TfFe&#39;][tuple(macrophage_cell_voxel)] -= qtty_fe
            transferrin.grid[&#39;Tf&#39;][tuple(macrophage_cell_voxel)] += qtty_fe + qtty_fe2
            macrophage_cell[&#39;iron_pool&#39;] += 2 * qtty_fe2 + qtty_fe

            if macrophage_cell[&#39;fpn&#39;] and macrophage_cell[&#39;status&#39;] not in {
                PhagocyteStatus.ACTIVE,
                PhagocyteStatus.ACTIVATING,
            }:
                # amount of iron to export is bounded by the amount of iron in the cell as well
                # as the amount which can be accepted by transferrin TODO: ask why not 2*Tf+TfFe?
                qtty: np.float64 = min(
                    macrophage_cell[&#39;iron_pool&#39;],
                    2 * transferrin.grid[&#39;Tf&#39;][tuple(macrophage_cell_voxel)],
                    macrophage_cell[&#39;iron_pool&#39;]
                    * transferrin.grid[&#39;Tf&#39;][tuple(macrophage_cell_voxel)]
                    * transferrin.ma_iron_export_rate
                    * transferrin.rel_iron_imp_exp_unit_t,
                )
                rel_tf_fe = iron_tf_reaction(
                    iron=qtty,
                    tf=transferrin.grid[&#39;Tf&#39;][tuple(macrophage_cell_voxel)],
                    tf_fe=transferrin.grid[&#39;TfFe&#39;][tuple(macrophage_cell_voxel)],
                    p1=transferrin.p1,
                    p2=transferrin.p2,
                    p3=transferrin.p3,
                )
                tffe_qtty = rel_tf_fe * qtty
                tffe2_qtty = (qtty - tffe_qtty) / 2

                transferrin.grid[&#39;Tf&#39;][tuple(macrophage_cell_voxel)] -= tffe_qtty + tffe2_qtty
                transferrin.grid[&#39;TfFe&#39;][tuple(macrophage_cell_voxel)] += tffe_qtty
                transferrin.grid[&#39;TfFe2&#39;][tuple(macrophage_cell_voxel)] += tffe2_qtty
                macrophage_cell[&#39;iron_pool&#39;] -= qtty

        # interaction with iron: transferrin -&gt; transferrin+[1,2]Fe
        transferrin_fe_capacity = 2 * transferrin.grid[&#39;Tf&#39;] + transferrin.grid[&#39;TfFe&#39;]
        potential_reactive_quantity = np.minimum(iron.grid, transferrin_fe_capacity)
        rel_tf_fe = iron_tf_reaction(
            iron=potential_reactive_quantity,
            tf=transferrin.grid[&#34;Tf&#34;],
            tf_fe=transferrin.grid[&#34;TfFe&#34;],
            p1=transferrin.p1,
            p2=transferrin.p2,
            p3=transferrin.p3,
        )
        tffe_qtty = rel_tf_fe * potential_reactive_quantity
        tffe2_qtty = (potential_reactive_quantity - tffe_qtty) / 2
        transferrin.grid[&#39;Tf&#39;] -= tffe_qtty + tffe2_qtty
        transferrin.grid[&#39;TfFe&#39;] += tffe_qtty
        transferrin.grid[&#39;TfFe2&#39;] += tffe2_qtty
        iron.grid -= potential_reactive_quantity
        # Note: asked Henrique why there is no transferrin+Fe -&gt; transferrin+2Fe reaction
        # answer was that this should already be accounted for

        # Degrade transferrin: done in liver

        # Diffusion of transferrin
        for component in {&#39;Tf&#39;, &#39;TfFe&#39;, &#39;TfFe2&#39;}:
            transferrin.grid[component][:] = apply_diffusion(
                variable=transferrin.grid[component],
                laplacian=molecules.laplacian,
                diffusivity=molecules.diffusion_constant,
                dt=self.time_step,
            )

        return state

    def summary_stats(self, state: State) -&gt; Dict[str, Any]:
        transferrin: TransferrinState = state.transferrin
        voxel_volume = state.voxel_volume

        concentration_0fe = np.mean(transferrin.grid[&#39;Tf&#39;]) / voxel_volume
        concentration_1fe = np.mean(transferrin.grid[&#39;TfFe&#39;]) / voxel_volume
        concentration_2fe = np.mean(transferrin.grid[&#39;TfFe2&#39;]) / voxel_volume

        concentration = concentration_0fe + concentration_1fe + concentration_2fe

        return {
            &#39;concentration&#39;: float(concentration),
            &#39;+0Fe concentration&#39;: float(concentration_0fe),
            &#39;+1Fe concentration&#39;: float(concentration_1fe),
            &#39;+2Fe concentration&#39;: float(concentration_2fe),
        }

    def visualization_data(self, state: State):
        transferrin: TransferrinState = state.transferrin
        return &#39;molecule&#39;, transferrin.grid</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="nlisim.module.ModuleModel" href="../module.html#nlisim.module.ModuleModel">ModuleModel</a></li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="nlisim.modules.transferrin.Transferrin.advance"><code class="name flex">
<span>def <span class="ident">advance</span></span>(<span>self, state: <a title="nlisim.state.State" href="../state.html#nlisim.state.State">State</a>, previous_time: float) ‑> <a title="nlisim.state.State" href="../state.html#nlisim.state.State">State</a></span>
</code></dt>
<dd>
<div class="desc"><p>Advance the state by a single time step.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def advance(self, state: State, previous_time: float) -&gt; State:
    &#34;&#34;&#34;Advance the state by a single time step.&#34;&#34;&#34;
    from nlisim.modules.iron import IronState
    from nlisim.modules.macrophage import MacrophageCellData, MacrophageState
    from nlisim.modules.molecules import MoleculesState
    from nlisim.modules.phagocyte import PhagocyteStatus

    transferrin: TransferrinState = state.transferrin
    iron: IronState = state.iron
    macrophage: MacrophageState = state.macrophage
    molecules: MoleculesState = state.molecules
    grid: RectangularGrid = state.grid
    # molecules: MoleculesState = state.molecules

    # interact with macrophages
    for macrophage_cell_index in macrophage.cells.alive():
        macrophage_cell: MacrophageCellData = macrophage.cells[macrophage_cell_index]
        macrophage_cell_voxel: Voxel = grid.get_voxel(macrophage_cell[&#39;point&#39;])

        # TODO: what is going on with these min&#39;s? hard to believe that these constants will &gt; 1
        qtty_fe2 = transferrin.grid[&#39;TfFe2&#39;][tuple(macrophage_cell_voxel)] * min(
            1.0, transferrin.ma_iron_import_rate * transferrin.rel_iron_imp_exp_unit_t
        )

        qtty_fe = transferrin.grid[&#39;TfFe&#39;][tuple(macrophage_cell_voxel)] * min(
            1.0, transferrin.ma_iron_import_rate * transferrin.rel_iron_imp_exp_unit_t
        )

        # macrophage uptakes iron, leaves transferrin+0Fe behind
        transferrin.grid[&#39;TfFe2&#39;][tuple(macrophage_cell_voxel)] -= qtty_fe2
        transferrin.grid[&#39;TfFe&#39;][tuple(macrophage_cell_voxel)] -= qtty_fe
        transferrin.grid[&#39;Tf&#39;][tuple(macrophage_cell_voxel)] += qtty_fe + qtty_fe2
        macrophage_cell[&#39;iron_pool&#39;] += 2 * qtty_fe2 + qtty_fe

        if macrophage_cell[&#39;fpn&#39;] and macrophage_cell[&#39;status&#39;] not in {
            PhagocyteStatus.ACTIVE,
            PhagocyteStatus.ACTIVATING,
        }:
            # amount of iron to export is bounded by the amount of iron in the cell as well
            # as the amount which can be accepted by transferrin TODO: ask why not 2*Tf+TfFe?
            qtty: np.float64 = min(
                macrophage_cell[&#39;iron_pool&#39;],
                2 * transferrin.grid[&#39;Tf&#39;][tuple(macrophage_cell_voxel)],
                macrophage_cell[&#39;iron_pool&#39;]
                * transferrin.grid[&#39;Tf&#39;][tuple(macrophage_cell_voxel)]
                * transferrin.ma_iron_export_rate
                * transferrin.rel_iron_imp_exp_unit_t,
            )
            rel_tf_fe = iron_tf_reaction(
                iron=qtty,
                tf=transferrin.grid[&#39;Tf&#39;][tuple(macrophage_cell_voxel)],
                tf_fe=transferrin.grid[&#39;TfFe&#39;][tuple(macrophage_cell_voxel)],
                p1=transferrin.p1,
                p2=transferrin.p2,
                p3=transferrin.p3,
            )
            tffe_qtty = rel_tf_fe * qtty
            tffe2_qtty = (qtty - tffe_qtty) / 2

            transferrin.grid[&#39;Tf&#39;][tuple(macrophage_cell_voxel)] -= tffe_qtty + tffe2_qtty
            transferrin.grid[&#39;TfFe&#39;][tuple(macrophage_cell_voxel)] += tffe_qtty
            transferrin.grid[&#39;TfFe2&#39;][tuple(macrophage_cell_voxel)] += tffe2_qtty
            macrophage_cell[&#39;iron_pool&#39;] -= qtty

    # interaction with iron: transferrin -&gt; transferrin+[1,2]Fe
    transferrin_fe_capacity = 2 * transferrin.grid[&#39;Tf&#39;] + transferrin.grid[&#39;TfFe&#39;]
    potential_reactive_quantity = np.minimum(iron.grid, transferrin_fe_capacity)
    rel_tf_fe = iron_tf_reaction(
        iron=potential_reactive_quantity,
        tf=transferrin.grid[&#34;Tf&#34;],
        tf_fe=transferrin.grid[&#34;TfFe&#34;],
        p1=transferrin.p1,
        p2=transferrin.p2,
        p3=transferrin.p3,
    )
    tffe_qtty = rel_tf_fe * potential_reactive_quantity
    tffe2_qtty = (potential_reactive_quantity - tffe_qtty) / 2
    transferrin.grid[&#39;Tf&#39;] -= tffe_qtty + tffe2_qtty
    transferrin.grid[&#39;TfFe&#39;] += tffe_qtty
    transferrin.grid[&#39;TfFe2&#39;] += tffe2_qtty
    iron.grid -= potential_reactive_quantity
    # Note: asked Henrique why there is no transferrin+Fe -&gt; transferrin+2Fe reaction
    # answer was that this should already be accounted for

    # Degrade transferrin: done in liver

    # Diffusion of transferrin
    for component in {&#39;Tf&#39;, &#39;TfFe&#39;, &#39;TfFe2&#39;}:
        transferrin.grid[component][:] = apply_diffusion(
            variable=transferrin.grid[component],
            laplacian=molecules.laplacian,
            diffusivity=molecules.diffusion_constant,
            dt=self.time_step,
        )

    return state</code></pre>
</details>
</dd>
</dl>
<h3>Inherited members</h3>
<ul class="hlist">
<li><code><b><a title="nlisim.module.ModuleModel" href="../module.html#nlisim.module.ModuleModel">ModuleModel</a></b></code>:
<ul class="hlist">
<li><code><a title="nlisim.module.ModuleModel.StateClass" href="../module.html#nlisim.module.ModuleModel.StateClass">StateClass</a></code></li>
<li><code><a title="nlisim.module.ModuleModel.construct" href="../module.html#nlisim.module.ModuleModel.construct">construct</a></code></li>
<li><code><a title="nlisim.module.ModuleModel.finalize" href="../module.html#nlisim.module.ModuleModel.finalize">finalize</a></code></li>
<li><code><a title="nlisim.module.ModuleModel.initialize" href="../module.html#nlisim.module.ModuleModel.initialize">initialize</a></code></li>
<li><code><a title="nlisim.module.ModuleModel.name" href="../module.html#nlisim.module.ModuleModel.name">name</a></code></li>
<li><code><a title="nlisim.module.ModuleModel.section" href="../module.html#nlisim.module.ModuleModel.section">section</a></code></li>
<li><code><a title="nlisim.module.ModuleModel.summary_stats" href="../module.html#nlisim.module.ModuleModel.summary_stats">summary_stats</a></code></li>
<li><code><a title="nlisim.module.ModuleModel.time_step" href="../module.html#nlisim.module.ModuleModel.time_step">time_step</a></code></li>
<li><code><a title="nlisim.module.ModuleModel.visualization_data" href="../module.html#nlisim.module.ModuleModel.visualization_data">visualization_data</a></code></li>
</ul>
</li>
</ul>
</dd>
<dt id="nlisim.modules.transferrin.TransferrinState"><code class="flex name class">
<span>class <span class="ident">TransferrinState</span></span>
<span>(</span><span>*, global_state: State, grid: numpy.ndarray = NOTHING)</span>
</code></dt>
<dd>
<div class="desc"><p>Base type intended to store the state for simulation modules.</p>
<p>This class contains serialization support for basic types (float, int, str,
bool) and numpy arrays of those types.
Modules containing more complicated
state must override the serialization mechanism with custom behavior.</p>
<p>Method generated by attrs for class TransferrinState.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class TransferrinState(ModuleState):
    grid: np.ndarray = attrib(
        default=attr.Factory(molecule_grid_factory, takes_self=True)
    )  # units: atto-mols
    k_m_tf_tafc: float  # units: aM
    p1: float
    p2: float
    p3: float
    threshold_log_hep: float
    threshold_hep: float
    default_apotf_rel_concentration: float  # units: proportion
    default_tffe_rel_concentration: float  # units: proportion
    default_tffe2_rel_concentration: float  # units: proportion
    default_tf_concentration: float
    default_apotf_concentration: float
    default_tffe_concentration: float
    default_tffe2_concentration: float
    tf_intercept: float
    tf_slope: float
    iron_imp_exp_t: float
    ma_iron_import_rate: float
    ma_iron_export_rate: float
    rel_iron_imp_exp_unit_t: float</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="nlisim.module.ModuleState" href="../module.html#nlisim.module.ModuleState">ModuleState</a></li>
</ul>
<h3>Class variables</h3>
<dl>
<dt id="nlisim.modules.transferrin.TransferrinState.default_apotf_concentration"><code class="name">var <span class="ident">default_apotf_concentration</span> : float</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="nlisim.modules.transferrin.TransferrinState.default_apotf_rel_concentration"><code class="name">var <span class="ident">default_apotf_rel_concentration</span> : float</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="nlisim.modules.transferrin.TransferrinState.default_tf_concentration"><code class="name">var <span class="ident">default_tf_concentration</span> : float</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="nlisim.modules.transferrin.TransferrinState.default_tffe2_concentration"><code class="name">var <span class="ident">default_tffe2_concentration</span> : float</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="nlisim.modules.transferrin.TransferrinState.default_tffe2_rel_concentration"><code class="name">var <span class="ident">default_tffe2_rel_concentration</span> : float</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="nlisim.modules.transferrin.TransferrinState.default_tffe_concentration"><code class="name">var <span class="ident">default_tffe_concentration</span> : float</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="nlisim.modules.transferrin.TransferrinState.default_tffe_rel_concentration"><code class="name">var <span class="ident">default_tffe_rel_concentration</span> : float</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="nlisim.modules.transferrin.TransferrinState.grid"><code class="name">var <span class="ident">grid</span> : numpy.ndarray</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="nlisim.modules.transferrin.TransferrinState.iron_imp_exp_t"><code class="name">var <span class="ident">iron_imp_exp_t</span> : float</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="nlisim.modules.transferrin.TransferrinState.k_m_tf_tafc"><code class="name">var <span class="ident">k_m_tf_tafc</span> : float</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="nlisim.modules.transferrin.TransferrinState.ma_iron_export_rate"><code class="name">var <span class="ident">ma_iron_export_rate</span> : float</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="nlisim.modules.transferrin.TransferrinState.ma_iron_import_rate"><code class="name">var <span class="ident">ma_iron_import_rate</span> : float</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="nlisim.modules.transferrin.TransferrinState.p1"><code class="name">var <span class="ident">p1</span> : float</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="nlisim.modules.transferrin.TransferrinState.p2"><code class="name">var <span class="ident">p2</span> : float</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="nlisim.modules.transferrin.TransferrinState.p3"><code class="name">var <span class="ident">p3</span> : float</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="nlisim.modules.transferrin.TransferrinState.rel_iron_imp_exp_unit_t"><code class="name">var <span class="ident">rel_iron_imp_exp_unit_t</span> : float</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="nlisim.modules.transferrin.TransferrinState.tf_intercept"><code class="name">var <span class="ident">tf_intercept</span> : float</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="nlisim.modules.transferrin.TransferrinState.tf_slope"><code class="name">var <span class="ident">tf_slope</span> : float</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="nlisim.modules.transferrin.TransferrinState.threshold_hep"><code class="name">var <span class="ident">threshold_hep</span> : float</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="nlisim.modules.transferrin.TransferrinState.threshold_log_hep"><code class="name">var <span class="ident">threshold_log_hep</span> : float</code></dt>
<dd>
<div class="desc"></div>
</dd>
</dl>
<h3>Inherited members</h3>
<ul class="hlist">
<li><code><b><a title="nlisim.module.ModuleState" href="../module.html#nlisim.module.ModuleState">ModuleState</a></b></code>:
<ul class="hlist">
<li><code><a title="nlisim.module.ModuleState.load_attribute" href="../module.html#nlisim.module.ModuleState.load_attribute">load_attribute</a></code></li>
<li><code><a title="nlisim.module.ModuleState.load_state" href="../module.html#nlisim.module.ModuleState.load_state">load_state</a></code></li>
<li><code><a title="nlisim.module.ModuleState.save_attribute" href="../module.html#nlisim.module.ModuleState.save_attribute">save_attribute</a></code></li>
<li><code><a title="nlisim.module.ModuleState.save_state" href="../module.html#nlisim.module.ModuleState.save_state">save_state</a></code></li>
</ul>
</li>
</ul>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="nlisim.modules" href="index.html">nlisim.modules</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="nlisim.modules.transferrin.molecule_grid_factory" href="#nlisim.modules.transferrin.molecule_grid_factory">molecule_grid_factory</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="nlisim.modules.transferrin.Transferrin" href="#nlisim.modules.transferrin.Transferrin">Transferrin</a></code></h4>
<ul class="">
<li><code><a title="nlisim.modules.transferrin.Transferrin.advance" href="#nlisim.modules.transferrin.Transferrin.advance">advance</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="nlisim.modules.transferrin.TransferrinState" href="#nlisim.modules.transferrin.TransferrinState">TransferrinState</a></code></h4>
<ul class="">
<li><code><a title="nlisim.modules.transferrin.TransferrinState.default_apotf_concentration" href="#nlisim.modules.transferrin.TransferrinState.default_apotf_concentration">default_apotf_concentration</a></code></li>
<li><code><a title="nlisim.modules.transferrin.TransferrinState.default_apotf_rel_concentration" href="#nlisim.modules.transferrin.TransferrinState.default_apotf_rel_concentration">default_apotf_rel_concentration</a></code></li>
<li><code><a title="nlisim.modules.transferrin.TransferrinState.default_tf_concentration" href="#nlisim.modules.transferrin.TransferrinState.default_tf_concentration">default_tf_concentration</a></code></li>
<li><code><a title="nlisim.modules.transferrin.TransferrinState.default_tffe2_concentration" href="#nlisim.modules.transferrin.TransferrinState.default_tffe2_concentration">default_tffe2_concentration</a></code></li>
<li><code><a title="nlisim.modules.transferrin.TransferrinState.default_tffe2_rel_concentration" href="#nlisim.modules.transferrin.TransferrinState.default_tffe2_rel_concentration">default_tffe2_rel_concentration</a></code></li>
<li><code><a title="nlisim.modules.transferrin.TransferrinState.default_tffe_concentration" href="#nlisim.modules.transferrin.TransferrinState.default_tffe_concentration">default_tffe_concentration</a></code></li>
<li><code><a title="nlisim.modules.transferrin.TransferrinState.default_tffe_rel_concentration" href="#nlisim.modules.transferrin.TransferrinState.default_tffe_rel_concentration">default_tffe_rel_concentration</a></code></li>
<li><code><a title="nlisim.modules.transferrin.TransferrinState.grid" href="#nlisim.modules.transferrin.TransferrinState.grid">grid</a></code></li>
<li><code><a title="nlisim.modules.transferrin.TransferrinState.iron_imp_exp_t" href="#nlisim.modules.transferrin.TransferrinState.iron_imp_exp_t">iron_imp_exp_t</a></code></li>
<li><code><a title="nlisim.modules.transferrin.TransferrinState.k_m_tf_tafc" href="#nlisim.modules.transferrin.TransferrinState.k_m_tf_tafc">k_m_tf_tafc</a></code></li>
<li><code><a title="nlisim.modules.transferrin.TransferrinState.ma_iron_export_rate" href="#nlisim.modules.transferrin.TransferrinState.ma_iron_export_rate">ma_iron_export_rate</a></code></li>
<li><code><a title="nlisim.modules.transferrin.TransferrinState.ma_iron_import_rate" href="#nlisim.modules.transferrin.TransferrinState.ma_iron_import_rate">ma_iron_import_rate</a></code></li>
<li><code><a title="nlisim.modules.transferrin.TransferrinState.p1" href="#nlisim.modules.transferrin.TransferrinState.p1">p1</a></code></li>
<li><code><a title="nlisim.modules.transferrin.TransferrinState.p2" href="#nlisim.modules.transferrin.TransferrinState.p2">p2</a></code></li>
<li><code><a title="nlisim.modules.transferrin.TransferrinState.p3" href="#nlisim.modules.transferrin.TransferrinState.p3">p3</a></code></li>
<li><code><a title="nlisim.modules.transferrin.TransferrinState.rel_iron_imp_exp_unit_t" href="#nlisim.modules.transferrin.TransferrinState.rel_iron_imp_exp_unit_t">rel_iron_imp_exp_unit_t</a></code></li>
<li><code><a title="nlisim.modules.transferrin.TransferrinState.tf_intercept" href="#nlisim.modules.transferrin.TransferrinState.tf_intercept">tf_intercept</a></code></li>
<li><code><a title="nlisim.modules.transferrin.TransferrinState.tf_slope" href="#nlisim.modules.transferrin.TransferrinState.tf_slope">tf_slope</a></code></li>
<li><code><a title="nlisim.modules.transferrin.TransferrinState.threshold_hep" href="#nlisim.modules.transferrin.TransferrinState.threshold_hep">threshold_hep</a></code></li>
<li><code><a title="nlisim.modules.transferrin.TransferrinState.threshold_log_hep" href="#nlisim.modules.transferrin.TransferrinState.threshold_log_hep">threshold_log_hep</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>